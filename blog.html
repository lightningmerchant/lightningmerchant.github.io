<!doctype html> <html lang='en'> <head> <meta charset='utf-8'> <meta name='viewport'content='width=device-width,initial-scale=1,shrink-to-fit=no'> <title>Blog</title> <meta name='description'content='Blog'> <link rel='stylesheet'href='https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css'integrity='sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO'crossorigin='anonymous'> <link rel='stylesheet'href='blog.css'> <script async src='https://www.googletagmanager.com/gtag/js?id=UA-127071864-1'></script> <script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","UA-127071864-1")</script> </head> <body> <nav class='navbar navbar-light bg-light mb-4'> <a class='navbar-brand'href='index.html'>Lightning Merchant</a> <ul class='nav nav-pills nav-fill mr-auto'> <li class='nav-item dropdown'> <a class='nav-link dropdown-toggle'href='#'id='navbarProductDropdown'role='button'data-toggle='dropdown'aria-haspopup='true'aria-expanded='false'> Products </a> <div class='dropdown-menu'aria-labelledby='navbarProductDropdown'> <a class='dropdown-item'href='index.html'>Lightning PoS</a> </div> </li> <li class='nav-item'> <a class='nav-link'href='blog.html'>Blog</a> </li> <li class='nav-item'> <a class='nav-link'href='contact-us.html'>Contact Us</a> </li> </ul> </nav> <main class='d-flex flex-row justify-content-center flex-wrap'> <div class='container'> <div class='row'> <div class='col-9'> <h1>Running a Lightning Node on Android ‚ö°Ô∏è</h1> <hr> <p> This post will detail the steps I followed to get a lightning node(<a href='https://github.com/ElementsProject/lightning'>c-lightning</a>) and a full bitcoin node(<a href='https://bitcoincore.org'>bitcoin core</a>) running on my old android phone(<a href='https://en.wikipedia.org/wiki/Moto_G5'>Moto G5</a>). </p> <h4 class='mt-4'>TL;DR</h4> <ul> <li><strong>Root</strong> android phone.</li> <li>Create a linux chroot with bitcoin and lightning running.</li> <li>Place on sd card and run it.</li> </ul> <p class='mt-4'>You will need to know your way around the command line and unix(the instructions are based off Debian). This is a proof of concept. There are simpler solutions for using lightning: </p> <ul> <li>Light or custodial wallets: <a href='https://play.google.com/store/apps/details?id=fr.acinq.eclair.wallet.mainnet2'>eclair</a>, <a href='https://bluewallet.io'>bluewallet</a>, <a href='https://htlc.me'>htlc.me</a> and many more.</li> <li>Pre-configured Raspberry Pi <a href='https://store.casa/lightning-node'>casa</a> and <a href='https://lightninginabox.co/product/raspiblitz-raspberry-pi-lightning-node'>lightninginabox</a>.</li> <li>Wait for <a href='https://github.com/bitcoin/bips/blob/master/bip-0157.mediawiki'>bip157</a> <a href='https://github.com/lightninglabs/neutrino'>neutrino</a> light client and watchtowers.</li> <li>Finally if you ask nicely, I might sell you one of these phones already <a href='https://lightningmerchant.com'>setup</a> üòé.</li> </ul> <h2 class='mt-5'>Disclaimer</h2> <hr> <p>I've been running this on my phone for a few weeks and it seems to work fine, however having lots of these as routing nodes might not be a good thing. Finally I'm not responsible if you brick your phone, lose money or worse üí•.</p> <h2 class='mt-5'>FAQ</h2> <hr> <dl> <dt class='mt-4'>How well does this run lightning and bitcoin?</dt> <dd><p>It has no problems running bitcoin with the full blockchain synced and I've managed to create/maintain lightning channels, spend and <strong>receive</strong> with it, all the whilst running android. I attribute this to the quality of the bitcoin core and c-lightning code.</dd> <dt class='mt-4'>Can I access bitcoin and lightning from android?</dt> <dd><p>Yep, so I created a quick python server which exposes bitcoin and lightning rpc on localhost. I also tried out <a href='https://github.com/ElementsProject/lightning-charge'>lightning charge</a> with <a href='https://github.com/ElementsProject/nanopos'>nanopos</a>. You can access it all from your browser in android using localhost(TODO: open source).</dd> <dt class='mt-4'>What's the battery life like?</dt> <dd><p>My old Moto G5 lasts about 2 days whilst bitcoin and lightning are running in the background.</dd> <dt class='mt-4'>How much data does it use? Can I use this with 4G?</dt> <dd><p>I've got it connected to wifi but I think 4G may be doable. To keep the blockchain synced you need at minimum 144mb per day. So thats a bit more than 5gb a month. I haven't checked how much bandwidth lightning uses yet(TODO: check how gossipy it is).</dd> <dt class='mt-4'>Can I do this without rooting my phone?</dt> <dd><p>It might be possible with the ndk or proot(TODO: checkout abcore, proot, termux and userland).</dd> <dt class='mt-4'>Can I do this without having to store the whole blockchain on sd card?</dt> <dd><p>We could use a pruned bitcoin node but it's currently not supported on c-lightning.</dd> </dl> <h2 class='mt-5'>Hardware List</h2> <hr> <ul> <li>Android phone which can be <strong>rooted</strong>. I used a <a href='https://amzn.to/2ObtlGi'>Motorola G5</a>.</li> <li>Sd card to store the bitcoin blockchain. I used the <a href='https://amzn.to/2Fjzy0d'>400gb micro-sdxc</a>.</li> <li>Usb to micro-usb cable.</li> <li>Sd card reader.</li> </ul> <h2 class='mt-5'>Software Prerequisite</h2> <hr> <ul> <li>Install android <a href='https://developer.android.com/studio/releases/platform-tools#downloads'>adb</a>(command line tool to communicate with phone when connected to computer).</li> <li>Add <a href='https://raw.githubusercontent.com/M0Rf30/android-udev-rules/master/51-android.rules'>udev rules</a> under <code class='bash'>/etc/udev/rules.d/51-android.rules</code>.</li> <li>Install <a href='https://wiki.debian.org/Debootstrap'>debootstrap</a>, a command line tool to create a Debian system in a subdirectory of another already installed system(android in our case).</li> </ul> <h2 class='mt-5'>Rooting Android</h2> <hr> <p>Feel free to skip this section if you've already rooted your phone. We will be using the custom recovery tool <a href='https://twrp.me'>TWRP</a> and <a href='https://github.com/topjohnwu/Magisk'>Magisk</a> to get root on our phones. You can search here if your device is supported: <a href='https://twrp.me/Devices'>https://twrp.me/Devices</a>.</p> <h3 class='mt-4'>Unlocking Bootloader</h3> <ul> <li><strong>WARNING</strong> this will void your warranty!!!</li> <li>On Moto G5 get developer options(settings, about phone, hit build number 7 times).</li> <li>In developer options, select OEM unlocking and USB debugging.</li> <li>Connect your phone to laptop using usb to micro-usb cable, <code class='bash'>./adb devices</code> should list your device if you've got adb and udev rules properly setup.</li> <li>Go to <a href='https://motorola-global-portal.custhelp.com/app/standalone/bootloader/unlock-your-device-a'>https://motorola-global-portal.custhelp.com/app/standalone/bootloader/unlock-your-device-a</a> and follow instructions.</li> <li><code class='bash'>./adb reboot bootloader</code></li> <li><code class='bash'>./fastboot oem get_unlock_data</code> get the code.</li> <li><code class='bash'>./fastboot oem unlock &lt;CODE FROM MOTOROLA&gt;</code> twice to unlock LOL.</li> <li>Enjoy the horrible warning when phone boots up üòÑ.</li> </ul> <h3 class='mt-4'>TWRP</h3> <ul> <li>Once your bootloader is unlocked, you can boot a custom recovery tool like TWRP.</li> <li>Go ahead and grab twrp image from <a href='https://twrp.me/motorola/motorolamotog5.html'>https://twrp.me/motorola/motorolamotog5.html</a>.</li> <li><code class='bash'>./adb reboot bootloader</code></li> <li><code class='bash'>./fastboot boot twrp-3.2.3-0-cedric.img</code></li> <li><strong>BACKUP</strong> At this point you should backup the stock android image.</li> <li>To backup once booted into TWRP, hit backup, save system.img, boot.img and recovery.img.</li> <li>This will put the backup somewhere under <code class='bash'>/sdcard</code>, you need to save it locally with <code class='bash'>./adb pull &lt;TWRP BACKUP LOCATION&gt;</code>.</li> </ul> <h3 class='mt-4'>Getting Root with Magisk</h3> <ul> <li>Download <a href='https://github.com/topjohnwu/Magisk/releases'>https://github.com/topjohnwu/Magisk/releases</a>.</li> <li>Put the Magisk zip onto your phone <code class='bash'>./adb push Magisk-v18.0.zip /sdcard</code>.</li> <li>Now boot into TWRP recovery.</li> <li><code class='bash'>./adb reboot bootloader</code></li> <li><code class='bash'>./fastboot boot twrp-3.2.3-0-cedric.img</code></li> <li>Once in TWRP, select Install and select the Magisk zip, reboot.</li> <li>Check you have root, <code class='bash'>./adb shell</code> then <code class='bash'>su</code> and <code class='bash'>whoami</code> should say <code class='bash'>root</code>. Congratulations you have rooted your device.</li> </ul> <h2 class='mt-5'>Creating a Linux Chroot</h2> <hr> <p>Phew, you've managed to root your device! Now the actual work begins. We will be creating a linux(Debian) environment to run bitcoin and lightning.</p> <ul> <li>Now we create a boostrap environment for your phones architechture, most Android phones are arm. Double check with: <pre class='bash'><code>./adb shell
uname -a
# leave chroot
exit
</code></pre></li> <li><p>My Moto G5 reports back <code class='bash'>armv7l</code> for which the corect Debian port is <code class='bash'>armhf</code>, check <a href='https://www.debian.org/ports/arm'>here</a>. I assume your computer is running <code class='bash'>x86-64</code>(check with <code class='bash'>uname -a</code> on your computer), so we will have to use qemu, install with <code class='bash'>apt-get install qemu-user-static</code>.</li> <li><p>First stage of bootstrap, running on your computer.</p> <pre class='bash'><code>mkdir bootstrap
# replace armhf with your phones architechture
debootstrap --foreign --arch=armhf --variant=minbase stable bootstrap
</code></pre> </li> <li><p>Copy over the magic qemu stuff <code class='bash'>cp /usr/bin/qemu-arm-static bootstrap/usr/bin</code>.</li> <li><p>Now we chroot into bootstrap and complete the second stage.</p> <pre class='bash'><code>chroot bootstrap
./debootstrap/debootstrap --second-stage
</code></pre> </li> <li>Create user alice with network access in our bootstrap environment(make sure you are still in the chroot). <pre class='bash'><code>export PATH=/bin:/sbin:/usr/bin:/usr/sbin

adduser alice

# add android network access
groupadd -g 3003 aid_inet
usermod -g 3003 _apt
usermod -g 3003 alice
</code></pre> </li> <li><p>Exit chroot(<code class='bash'>exit</code>), download and copy over <a href='https://bitcoincore.org/en/download/'>bitcoin core</a>. Use the correct version(32 bit arm for my Moto G5), <code class='bash'>cp -R bitcoin-0.17.1 bootstrap/home/alice</code>.</li> <li><p>Now back in chroot and compile c-lightning for arm.</p> <pre class='bash'><code>chroot bootstrap
export PATH=/bin:/sbin:/usr/bin:/usr/sbin

apt-get install autoconf automake build-essential git libtool libgmp-dev libsqlite3-dev python python3 net-tools zlib1g-dev

# become alice
/bin/su - alice
export PATH=/bin:/sbin:/usr/bin:/usr/sbin

git clone https://github.com/ElementsProject/lightning.git
cd lightning
git checkout v0.7.0
./configure
make
</code></pre> </li> </ul> <h2 class='mt-5'>Place on sd card and run it!</h2> <hr> <ul> <li><p>Finally let's copy over the bootstrap environment to your sd card. Insert your sd card into card reader and find out the device name using <code class='bash'>fdisk -l</code>. Mine was called <code class='bash'>/dev/mmcblk0</code>.</li> <li><p><strong>WARNING</strong> backup your sd card first.</li> <li><p>Wipe it with <code class='bash'>wipefs -a /dev/mmcblk0</code>.</li> <li><p>Create a small FAT partition to stop android complaining.</p> <pre class='bash'><code>fdisk /dev/mmcblk0
n
# follow the defaults for primary, parition(1) and first sector

# when prompted for last sector, make it 20mb
+20M

# now change to exFat
t
# partition type we want is 7 HPFS/NTFS/exFAT 
7
</code></pre> </li> <li>Create the second parition where we will put our bootstrap environment. <pre class='bash'><code>fdisk /dev/mmcblk0
n
# follow the defaults for primary, parition(2), first sector and last sector(take up all the space)
# partition type is 83 Linux by default

# exit and save
w
</code></pre> </li> <li><p><code class='bash'>fdisk -l</code> should show something like <code class='bash'>mmcblk0</code> for sd card, <code class='bash'>mmcblk0p1</code> is small fat partition and <code class='bash'>mmcblk0p2</code> is where our bootstrap environment will be.</li> <li><p>Make <code class='bash'>mmcblk0p2</code> an EXT4 file system with label <em>lightning</em>, <code class='bash'>mkfs.ext4 /dev/mmcblk0p2 -L lightning</code></li> <li><p>Mount and copy over bootstrap environment</p> <pre class='bash'><code>mount /dev/mmcblk0p2 /mnt
cp -Rp bootstrap /mnt
umount /mnt
</code></pre> </li> <li>Great we now have everything setup. Put the sd card back into your phone, connect to your computer and drop into <code class='bash'>./adb shell</code>. <pre class='bash'><code>su

# create a directory to mount our bootstrap environment
mkdir /data/lit

# we need to find our sd card device name, usually android will name it mmcblk1
blkid
# look for the one labeled lightning, for me it was mmcblk1p2

# let's mount everything, replace mmcblk1p2 with your sd card partition containing the bootstrap environment
mount /dev/block/mmcblk1p2 /data/lit
mount --bind /dev /data/lit/bootstrap/dev
mount --bind /proc /data/lit/bootstrap/proc
mount --bind /sys /data/lit/bootstrap/sys

# we chroot from android to our bootstrap environment
chroot /data/lit/bootstrap /bin/bash

# become alice
/bin/su - alice

export PATH=/bin:/sbin:/usr/bin:/usr/sbin:/home/alice/bitcoin-0.17.1/bin

/home/alice/bitcoin-0.17.1/bin/bitcoind -daemon
/home/alice/lightning/lightningd/lightningd
</code></pre> </li> </ul> <h2 class='mt-5'>Conclusion</h2> <hr> <p>Congratulations üôå, that was a lot of work! You now have bitcoin and lightning running on your phone. The next requirements you'll probably have:</p> <dl> <dt class='mt-4'>It's taking ages to sync the bitcoin blockchain.</dt> <dd><p>Sync/Initial Block Download on your computer than copy over <code class='bash'>.bitcoin</code> directory to sd card.</dd> <dt class='mt-4'>I want to get it running without having to connect to computer and <code class='bash'>./adb shell</code>.</dt> <dd><p>I made a quick android app which basically runs these commands using <a href='https://developer.android.com/reference/java/lang/ProcessBuilder'>ProcessBuilder</a>(TODO: open source).</dd> <dt class='mt-4'>I want to control/getinfo about bitcoin and lightning.</dt> <dd><p>Yep, so I created a quick python server which exposes bitcoin and lightning rpc on localhost. I also tried out <a href='https://github.com/ElementsProject/lightning-charge'>lightning charge</a> with <a href='https://github.com/ElementsProject/nanopos'>nanopos</a>. You can access it all from your browser in android using localhost(TODO: open source).</dd> <dt class='mt-4'>I don't have a static ip.</dt> <dd><p>Use <a href='https://www.torproject.org'>Tor</a>.</dd> <dt class='mt-4'>I'd like to donate, buy you a beer/coffee, name my first born after you.</dt> <dd> <p>my lightning node(you'll need to be running tor): <code>0340023797652d7ba0d8065f8fb412fd537dee0875634a68679d0415d5a2369a03@osunmcx5dqi5ibmrbskjxdlg2hvaf22ja6nl5apcjorbqom5mwrti5qd.onion:9735</code></p> <p>my btc(bech32): <code>bc1q7fzlt08k2ann9ullp4cl2w6mretm89xnv64agc</code></p> <p>my btc: <code>36Y5SmSLxZ2maRUUParf4QWuGGYELZssde</code></p> <p>buy a phone already <a href='https://lightningmerchant.com'>setup</a></p> </dd> </dl> </div> <div class='col-3'> <div class='mt-4 align-self-center'> <div class='mx-5'> <img id='phone1-image'src='phone1.png'> <img id='phone2-image'src='phone2.png'style='display:none'> <img id='phone3-image'src='phone3.png'style='display:none'> <img id='phone4-image'src='phone4.png'style='display:none'> </div> <div class='d-flex flex-row justify-content-around mt-3'> <a> <img id='phone1-thumbnail-image'class='img-thumbnail'src='phone1-thumbnail.png'> </a> <a> <img id='phone2-thumbnail-image'class='img-thumbnail'src='phone2-thumbnail.png'> </a> <a> <img id='phone3-thumbnail-image'class='img-thumbnail'src='phone3-thumbnail.png'> </a> <a> <img id='phone4-thumbnail-image'class='img-thumbnail'src='phone4-thumbnail.png'> </a> </div> </div> </div> </div> </div> </main> <script src='https://code.jquery.com/jquery-3.3.1.min.js'integrity='sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8='crossorigin='anonymous'></script> <script src='https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js'integrity='sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy'crossorigin='anonymous'></script> <script src='index.js'></script> 